@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@using Newtonsoft.Json
@using Umbraco.Cms.Web.Common
@using website
@using website.Models.ViewModels
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
@inject UmbracoHelper _umbracoHelper

@functions {
    public string GetAntiXsrfRequestToken()
    {
        return Xsrf.GetAndStoreTokens(Context).RequestToken;
    }
}

@{
    Layout = "_Layout.cshtml";

    // 1. Check for Verification Mode (Free Orders)
    bool isVerifyMode = Context.Request.Query["verify"] == "true";
    string orderIdStr = Context.Request.Query["oid"];
    string verifyError = Context.Request.Query["error"];

    // 2. Prepare Data for Standard Checkout (Stripe Orders)
    var serializedOrderVm = TempData["OrderData"] as string;
    OrderVm? orderData = null;

    if (!string.IsNullOrEmpty(serializedOrderVm))
    {
        orderData = JsonConvert.DeserializeObject<OrderVm>(serializedOrderVm);
        // Keep TempData so it's available for the CreatePaymentIntent call
        TempData.Keep("OrderData");
    }
}

<div class="container mt-5 mb-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">

            @if (isVerifyMode && !string.IsNullOrEmpty(orderIdStr))
            {
                /* -----------------------------------------------------------
                   SCENARIO A: VERIFICATION MODE (Free Tickets)
                   ----------------------------------------------------------- */
                <div class="card shadow-sm rounded-lg">
                    <div class="card-header bg-success text-white">
                        <h2 class="h4 mb-0">Verify Your Order</h2>
                    </div>
                    <div class="card-body">
                        <p class="lead">Your tickets are free! We just need to verify you are human.</p>
                        <p>We have sent a <strong>4-digit PIN</strong> to your email address. Please enter it below to receive your tickets.</p>

                        @if (verifyError == "invalid")
                        {
                            <div class="alert alert-danger">
                                <strong>Error:</strong> The PIN you entered was incorrect. Please check your email and try again.
                            </div>
                        }

                        @using (Html.BeginUmbracoForm<CheckoutController>(nameof(CheckoutController.ProcessVerification), FormMethod.Post))
                        {
                            <input type="hidden" name="orderId" value="@orderIdStr" />

                            <div class="mb-4 text-center">
                                <label for="pin" class="form-label fw-bold">Enter Verification PIN</label>
                                <input type="text"
                                       id="pin"
                                       name="pin"
                                       class="form-control form-control-lg text-center mx-auto"
                                       placeholder="XXXX"
                                       maxlength="4"
                                       style="letter-spacing: 8px; font-weight: bold; font-size: 2rem; max-width: 200px;"
                                       required
                                       autocomplete="off" />
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg">Verify & Get Tickets</button>
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                /* -----------------------------------------------------------
                   SCENARIO B: STANDARD CHECKOUT (Paid Tickets / Stripe)
                   ----------------------------------------------------------- */
                if (orderData == null || !orderData.Tickets.Any())
                {
                    <div class="alert alert-warning">
                        <h4>Your Basket is Empty</h4>
                        <p>Your session may have expired. Please find an event and select tickets.</p>
                        <a href="/events/" class="btn btn-primary">Find Events</a>
                    </div>
                }
                else
                {
                    <div class="card shadow-sm rounded-lg">
                        <div class="card-header bg-primary text-white">
                            <h2 class="h4 mb-0">Checkout</h2>
                        </div>
                        <div class="card-body">
                            <h3 class="h5">Order Summary</h3>
                            <ul class="list-group list-group-flush mb-4">
                                @foreach (var ticket in orderData.Tickets)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>@ticket.EventName</strong> - @ticket.Type
                                            <small class="d-block text-muted">@ticket.Quantity x £@((ticket.Cost / 100.0m).ToString("F2"))</small>
                                        </div>
                                        <span class="fw-bold">£@((ticket.Cost * ticket.Quantity / 100.0m).ToString("F2"))</span>
                                    </li>
                                }
                                <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                                    <strong class="h5">Total</strong>
                                    <span class="h5 fw-bold text-primary">£@((orderData.Tickets.Sum(t => (long)t.Cost * t.Quantity) / 100.0m).ToString("F2"))</span>
                                </li>
                            </ul>

                            <hr />

                            <form id="payment-form">
                                <h3 class="h5 mt-4">Your Payment Details</h3>
                                <p>Enter your details below to complete the purchase.</p>

                                <div id="payment-element" class="mb-3">
                                    </div>

                                <div id="payment-message" class="text-danger mb-3"></div>

                                <div class="d-grid gap-2 mt-4">
                                    <button id="submit" class="btn btn-success btn-lg">
                                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                        <span id="button-text">Pay Now</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    /* -----------------------------------------------------------
                       STRIPE JAVASCRIPT
                       Only rendered when in Payment Mode
                       ----------------------------------------------------------- */
                    <script src="https://js.stripe.com/v3/"></script>

                    <script>
                        document.addEventListener('DOMContentLoaded', async () => {
                            const paymentForm = document.getElementById('payment-form');
                            // Safety check: if we are in Verify Mode, this form won't exist, so we stop here.
                            if (!paymentForm) {
                                return;
                            }

                            let stripe, elements;

                            const response = await fetch('/umbraco/surface/checkout/createpaymentintent', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'RequestVerificationToken': '@GetAntiXsrfRequestToken()'
                                }
                            });

                            const { clientSecret, publishableKey, error } = await response.json();

                            if (error) {
                                const messageContainer = document.querySelector("#payment-message");
                                messageContainer.textContent = error;
                                return;
                            }

                            stripe = Stripe(publishableKey);

                            const appearance = { theme: 'stripe' };
                            elements = stripe.elements({ appearance, clientSecret });

                            const paymentElement = elements.create("payment", {
                                paymentMethodTypes: ['card']
                            });
                            paymentElement.mount("#payment-element");

                            paymentForm.addEventListener('submit', async (e) => {
                                e.preventDefault();
                                setLoading(true);

                                const yourOrderPageUrl = '@(_umbracoHelper.ContentAtRoot().DescendantsOrSelfOfType("yourOrder").FirstOrDefault()?.Url(mode: UrlMode.Absolute))';

                                if (!yourOrderPageUrl) {
                                    const messageContainer = document.querySelector("#payment-message");
                                    messageContainer.textContent = "Error: Success page not configured. Please contact support.";
                                    setLoading(false);
                                    return;
                                }

                                const { error } = await stripe.confirmPayment({
                                    elements,
                                    confirmParams: {
                                        return_url: yourOrderPageUrl,
                                    },
                                });

                                if (error.type === "card_error" || error.type === "validation_error") {
                                    showMessage(error.message);
                                } else {
                                    showMessage("An unexpected error occurred.");
                                }

                                setLoading(false);
                            });

                            function showMessage(messageText) {
                                const messageContainer = document.querySelector("#payment-message");
                                messageContainer.textContent = messageText;
                            }

                            function setLoading(isLoading) {
                                const submitButton = document.querySelector("#submit");
                                const buttonText = document.querySelector("#button-text");
                                const spinner = submitButton.querySelector(".spinner-border");

                                submitButton.disabled = isLoading;
                                if (isLoading) {
                                    spinner.classList.remove("d-none");
                                    buttonText.classList.add("d-none");
                                } else {
                                    spinner.classList.add("d-none");
                                    buttonText.classList.remove("d-none");
                                }
                            }
                        });
                    </script>
                }
            }
        </div>
    </div>
</div>